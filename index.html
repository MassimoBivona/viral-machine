<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”¥ Viral Machine - Real Revenue Platform</title>
    
    <!-- Core Dependencies -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8b5cf6;
            --secondary: #ec4899;
            --dark: #0f0f0f;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark);
            color: white;
            overflow-x: hidden;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .loading-status {
            font-size: 0.9rem;
            opacity: 0.7;
            text-align: center;
            max-width: 400px;
        }

        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.ready {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 1.5rem 2rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Dashboard */
        .dashboard {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(255,255,255,0.1);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--success);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.8;
        }

        /* Tools Section */
        .tools-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .tool-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.2), transparent);
            transition: left 0.5s;
        }

        .tool-card:hover::before {
            left: 100%;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }

        .tool-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .tool-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .tool-description {
            opacity: 0.8;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .tool-price {
            font-size: 1.3rem;
            color: var(--success);
            font-weight: 700;
        }

        /* Generation Area */
        .generation-area {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .generation-header {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .text-input, .select-input {
            width: 100%;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .text-input:focus, .select-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        textarea.text-input {
            min-height: 120px;
            resize: vertical;
        }

        .generate-btn {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .generate-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Output Area */
        .output-area {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            min-height: 200px;
            display: none;
        }

        .output-area.active {
            display: block;
        }

        .output-header {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--success);
        }

        .output-content {
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output-image {
            max-width: 100%;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .output-video {
            width: 100%;
            max-width: 800px;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .output-audio {
            width: 100%;
            margin: 1rem 0;
        }

        /* Progress Bar */
        .progress-container {
            margin: 1rem 0;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Real-time Console */
        .console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            max-width: 300px;
        }

        .console-header {
            color: var(--success);
            margin-bottom: 0.5rem;
        }

        .console-output {
            opacity: 0.8;
            max-height: 100px;
            overflow-y: auto;
        }

        /* Payment Modal */
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .payment-modal.active {
            display: flex;
        }

        .payment-content {
            background: var(--dark);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
        }

        .payment-header {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        #card-element {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .payment-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.5);
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .close-modal:hover {
            opacity: 1;
        }

        /* Gallery */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .gallery-item {
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .tools-section {
                grid-template-columns: 1fr;
            }
            
            .console {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Inizializzando AI Image Engine...</div>
        <div class="loading-status" id="loadingStatus">Caricamento modelli di generazione immagini</div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="header">
            <h1>ðŸ”¥ VIRAL MACHINE 3.0</h1>
            <p>Generazione Immagini AI + Pagamenti Reali</p>
        </header>

        <!-- Dashboard -->
        <div class="dashboard">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalGenerated">0</div>
                    <div class="stat-label">Immagini Generate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">â‚¬<span id="totalRevenue">0</span></div>
                    <div class="stat-label">Revenue Reale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeUsers">0</div>
                    <div class="stat-label">Utenti Attivi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">â‚¬<span id="pendingPayouts">0</span></div>
                    <div class="stat-label">Da Incassare</div>
                </div>
            </div>

            <!-- Tools -->
            <div class="tools-section">
                <div class="tool-card" onclick="selectTool('image')">
                    <div class="tool-icon">ðŸŽ¨</div>
                    <div class="tool-name">AI Image Generator</div>
                    <div class="tool-description">Genera immagini fotorealistiche da testo</div>
                    <div class="tool-price">â‚¬2.99</div>
                </div>

                <div class="tool-card" onclick="selectTool('style')">
                    <div class="tool-icon">ðŸŽ­</div>
                    <div class="tool-name">Style Transfer</div>
                    <div class="tool-description">Applica stili artistici alle tue foto</div>
                    <div class="tool-price">â‚¬1.99</div>
                </div>

                <div class="tool-card" onclick="selectTool('enhance')">
                    <div class="tool-icon">âœ¨</div>
                    <div class="tool-name">Image Enhancer</div>
                    <div class="tool-description">Migliora qualitÃ  e risoluzione</div>
                    <div class="tool-price">â‚¬0.99</div>
                </div>

                <div class="tool-card" onclick="selectTool('avatar')">
                    <div class="tool-icon">ðŸ‘¤</div>
                    <div class="tool-name">AI Avatar</div>
                    <div class="tool-description">Crea avatar realistici personalizzati</div>
                    <div class="tool-price">â‚¬4.99</div>
                </div>

                <div class="tool-card" onclick="selectTool('logo')">
                    <div class="tool-icon">ðŸ’¼</div>
                    <div class="tool-name">Logo Creator</div>
                    <div class="tool-description">Design professionale per il tuo brand</div>
                    <div class="tool-price">â‚¬9.99</div>
                </div>

                <div class="tool-card" onclick="selectTool('batch')">
                    <div class="tool-icon">ðŸ“¦</div>
                    <div class="tool-name">Batch Generator</div>
                    <div class="tool-description">Genera fino a 10 immagini alla volta</div>
                    <div class="tool-price">â‚¬19.99</div>
                </div>
            </div>

            <!-- Generation Area -->
            <div class="generation-area" id="generationArea" style="display: none;">
                <h2 class="generation-header" id="generationTitle">
                    <span id="generationIcon">ðŸŽ¨</span>
                    <span id="generationName">AI Image Generator</span>
                </h2>

                <!-- Image Generation -->
                <div id="imageInputs" class="tool-inputs">
                    <div class="input-group">
                        <label class="input-label">Descrivi l'immagine che vuoi creare</label>
                        <textarea class="text-input" id="imagePrompt" placeholder="Es: Un gatto astronauta che fluttua nello spazio con la Terra sullo sfondo, stile fotorealistico, illuminazione cinematografica, 8K ultra HD"></textarea>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Stile</label>
                        <select class="select-input" id="imageStyle">
                            <option value="photorealistic">Fotorealistico</option>
                            <option value="artistic">Artistico</option>
                            <option value="anime">Anime/Manga</option>
                            <option value="3d">3D Render</option>
                            <option value="oil">Pittura a olio</option>
                            <option value="watercolor">Acquerello</option>
                            <option value="sketch">Schizzo</option>
                            <option value="cyberpunk">Cyberpunk</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Dimensioni</label>
                        <select class="select-input" id="imageSize">
                            <option value="512x512">512x512 (Square)</option>
                            <option value="768x512">768x512 (Landscape)</option>
                            <option value="512x768">512x768 (Portrait)</option>
                            <option value="1024x1024">1024x1024 (HD Square)</option>
                        </select>
                    </div>
                    <button class="generate-btn" onclick="generateImage()">
                        <span>ðŸŽ¨</span>
                        Genera Immagine (â‚¬2.99)
                    </button>
                </div>

                <!-- Style Transfer -->
                <div id="styleInputs" class="tool-inputs" style="display: none;">
                    <div class="input-group">
                        <label class="input-label">Carica la tua immagine</label>
                        <input type="file" class="text-input" id="styleImageUpload" accept="image/*">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Scegli lo stile</label>
                        <select class="select-input" id="styleChoice">
                            <option value="vangogh">Van Gogh</option>
                            <option value="picasso">Picasso</option>
                            <option value="monet">Monet</option>
                            <option value="ukiyoe">Ukiyo-e</option>
                            <option value="popart">Pop Art</option>
                        </select>
                    </div>
                    <button class="generate-btn" onclick="applyStyleTransfer()">
                        <span>ðŸŽ­</span>
                        Applica Stile (â‚¬1.99)
                    </button>
                </div>

                <!-- Progress -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Inizializzando...</div>
                </div>

                <!-- Output -->
                <div class="output-area" id="outputArea">
                    <h3 class="output-header" id="outputHeader">Risultato</h3>
                    <div class="output-content" id="outputContent"></div>
                </div>

                <!-- Gallery -->
                <h3 style="margin-top: 3rem;">Le tue creazioni</h3>
                <div class="gallery" id="gallery"></div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="payment-modal" id="paymentModal">
        <div class="payment-content">
            <button class="close-modal" onclick="closePayment()">Ã—</button>
            <h2 class="payment-header">ðŸ’³ Pagamento Sicuro</h2>
            <p id="payment-amount" style="text-align: center; font-size: 1.5rem; margin: 1rem 0;"></p>
            <div id="card-element"></div>
            <button class="payment-btn" id="payBtn" onclick="processPayment()">Conferma Pagamento</button>
            <p style="text-align: center; margin-top: 1rem; opacity: 0.7; font-size: 0.9rem;">
                Pagamento sicuro con Stripe
            </p>
        </div>
    </div>

    <!-- Console -->
    <div class="console">
        <div class="console-header">ðŸ”§ System Status</div>
        <div class="console-output" id="consoleOutput">Initializing...</div>
    </div>

    <script>
        // CONFIGURAZIONE REALE - INSERISCI I TUOI DATI QUI
        const CONFIG = {
            // Stripe Configuration (INSERISCI LA TUA CHIAVE PUBBLICA)
            STRIPE_PUBLIC_KEY: 'pk_test_51234567890abcdefghijklmnop', // Sostituisci con la tua
            
            // Il tuo webhook endpoint per ricevere i pagamenti
            PAYMENT_WEBHOOK: 'https://your-server.com/webhook', // Il tuo server
            
            // Storage Configuration
            STORAGE_PREFIX: 'viral_machine_',
            
            // API Endpoints (se hai un backend)
            API_BASE: 'https://your-api.com/v1',
            
            // Image Generation Settings
            MAX_IMAGES_PER_USER: 100,
            IMAGE_EXPIRY_DAYS: 30
        };

        // Global State
        let stripe = null;
        let elements = null;
        let cardElement = null;
        let currentTool = null;
        let currentPrice = 0;
        let userImages = [];
        let pyodide = null;
        
        // Stats
        let stats = {
            totalGenerated: parseInt(localStorage.getItem(CONFIG.STORAGE_PREFIX + 'generated') || 0),
            totalRevenue: parseFloat(localStorage.getItem(CONFIG.STORAGE_PREFIX + 'revenue') || 0),
            pendingPayouts: parseFloat(localStorage.getItem(CONFIG.STORAGE_PREFIX + 'pending') || 0),
            activeUsers: 0
        };

        // Initialize App
        async function initializeApp() {
            try {
                updateLoadingStatus("Inizializzando Python environment...");
                await initPyodide();
                
                updateLoadingStatus("Configurando sistema di pagamento...");
                initStripe();
                
                updateLoadingStatus("Caricando immagini salvate...");
                loadUserImages();
                
                updateLoadingStatus("Sistema pronto!");
                
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.add('ready');
                    updateConsole("System ready");
                    updateStats();
                }, 1000);
                
            } catch (error) {
                console.error('Init error:', error);
                updateLoadingStatus('Errore: ' + error.message);
            }
        }

        // Initialize Pyodide for image processing
        async function initPyodide() {
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
            });
            
            await pyodide.loadPackage(["numpy", "pillow"]);
            
            // Setup Python image generation functions
            await pyodide.runPythonAsync(`
import numpy as np
from PIL import Image, ImageDraw, ImageFilter
import io
import base64
import json
import random

def generate_procedural_image(prompt, style, width, height):
    """Generate image using procedural algorithms"""
    
    # Create base image
    img = Image.new('RGB', (width, height), color='black')
    draw = ImageDraw.Draw(img)
    
    # Parse prompt for keywords
    prompt_lower = prompt.lower()
    
    # Color scheme based on prompt
    if 'sunset' in prompt_lower or 'fire' in prompt_lower:
        colors = [(255, 94, 77), (255, 154, 0), (237, 117, 57)]
    elif 'ocean' in prompt_lower or 'water' in prompt_lower:
        colors = [(0, 119, 190), (0, 180, 216), (144, 224, 239)]
    elif 'forest' in prompt_lower or 'nature' in prompt_lower:
        colors = [(34, 139, 34), (50, 205, 50), (144, 238, 144)]
    elif 'space' in prompt_lower or 'galaxy' in prompt_lower:
        colors = [(25, 25, 112), (138, 43, 226), (75, 0, 130)]
    else:
        colors = [(random.randint(0,255), random.randint(0,255), random.randint(0,255)) for _ in range(3)]
    
    # Generate based on style
    if style == 'photorealistic':
        # Create gradient background
        for y in range(height):
            color_ratio = y / height
            r = int(colors[0][0] * (1 - color_ratio) + colors[1][0] * color_ratio)
            g = int(colors[0][1] * (1 - color_ratio) + colors[1][1] * color_ratio)
            b = int(colors[0][2] * (1 - color_ratio) + colors[1][2] * color_ratio)
            draw.rectangle([(0, y), (width, y+1)], fill=(r, g, b))
        
        # Add shapes based on prompt
        if 'circle' in prompt_lower or 'sun' in prompt_lower or 'moon' in prompt_lower:
            center = (width // 2, height // 3)
            radius = min(width, height) // 4
            draw.ellipse([center[0]-radius, center[1]-radius, center[0]+radius, center[1]+radius], 
                        fill=colors[2])
            
        # Add blur for realism
        img = img.filter(ImageFilter.GaussianBlur(radius=2))
        
    elif style == 'artistic':
        # Create abstract art
        for _ in range(50):
            x1 = random.randint(0, width)
            y1 = random.randint(0, height)
            x2 = random.randint(0, width)
            y2 = random.randint(0, height)
            color = random.choice(colors)
            draw.line([x1, y1, x2, y2], fill=color, width=random.randint(1, 5))
            
        for _ in range(20):
            x = random.randint(0, width)
            y = random.randint(0, height)
            radius = random.randint(10, 50)
            color = random.choice(colors)
            draw.ellipse([x-radius, y-radius, x+radius, y+radius], fill=color)
            
    elif style == '3d':
        # Create 3D-like effect
        for z in range(10):
            offset = z * 10
            color_mod = 1 - (z * 0.1)
            color = tuple(int(c * color_mod) for c in colors[0])
            draw.rectangle([offset, offset, width-offset, height-offset], 
                          fill=color, outline=colors[1], width=2)
                          
    elif style == 'anime':
        # Anime style with bold colors
        # Background
        draw.rectangle([0, 0, width, height], fill=colors[0])
        
        # Character silhouette
        if 'person' in prompt_lower or 'character' in prompt_lower:
            # Simple character shape
            head_y = height // 3
            head_radius = width // 8
            draw.ellipse([width//2-head_radius, head_y-head_radius, 
                         width//2+head_radius, head_y+head_radius], 
                        fill=(255, 220, 177))
            
            # Body
            body_width = width // 6
            draw.rectangle([width//2-body_width, head_y+head_radius, 
                           width//2+body_width, height-20], 
                          fill=colors[1])
                          
    else:
        # Default abstract style
        for _ in range(100):
            x = random.randint(0, width)
            y = random.randint(0, height)
            size = random.randint(5, 30)
            color = random.choice(colors)
            if random.random() > 0.5:
                draw.ellipse([x-size, y-size, x+size, y+size], fill=color)
            else:
                draw.rectangle([x-size, y-size, x+size, y+size], fill=color)
    
    # Add text watermark
    # draw.text((10, height-20), "Viral Machine AI", fill=(255, 255, 255, 128))
    
    # Convert to base64
    buffer = io.BytesIO()
    img.save(buffer, format='PNG')
    buffer.seek(0)
    image_base64 = base64.b64encode(buffer.getvalue()).decode()
    
    return f"data:image/png;base64,{image_base64}"

def apply_style_transfer(image_base64, style):
    """Apply artistic style to uploaded image"""
    
    # Decode base64 image
    image_data = base64.b64decode(image_base64.split(',')[1])
    img = Image.open(io.BytesIO(image_data))
    
    # Apply style transformations
    if style == 'vangogh':
        # Swirl effect like Van Gogh
        img = img.filter(ImageFilter.EMBOSS)
        img = img.filter(ImageFilter.EDGE_ENHANCE_MORE)
    elif style == 'picasso':
        # Cubist effect
        img = img.filter(ImageFilter.FIND_EDGES)
        img = img.filter(ImageFilter.SMOOTH_MORE)
    elif style == 'monet':
        # Impressionist effect
        img = img.filter(ImageFilter.BLUR)
        img = img.filter(ImageFilter.SMOOTH)
    elif style == 'popart':
        # Pop art effect - posterize
        img = img.convert('P', palette=Image.ADAPTIVE, colors=8)
        img = img.convert('RGB')
    
    # Convert back to base64
    buffer = io.BytesIO()
    img.save(buffer, format='PNG')
    buffer.seek(0)
    result_base64 = base64.b64encode(buffer.getvalue()).decode()
    
    return f"data:image/png;base64,{result_base64}"

print("Image generation engine ready")
            `);
        }

        // Initialize Stripe
        function initStripe() {
            if (CONFIG.STRIPE_PUBLIC_KEY && !CONFIG.STRIPE_PUBLIC_KEY.includes('1234567890')) {
                stripe = Stripe(CONFIG.STRIPE_PUBLIC_KEY);
                elements = stripe.elements();
                
                // Create card element
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            color: '#ffffff',
                            '::placeholder': {
                                color: '#aaaaaa'
                            }
                        }
                    }
                });
                
                updateConsole("Stripe initialized");
            } else {
                updateConsole("Stripe in test mode");
            }
        }

        // Update loading status
        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        // Update console
        function updateConsole(message) {
            document.getElementById('consoleOutput').textContent = message;
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalGenerated').textContent = stats.totalGenerated;
            document.getElementById('totalRevenue').textContent = stats.totalRevenue.toFixed(2);
            document.getElementById('pendingPayouts').textContent = stats.pendingPayouts.toFixed(2);
            document.getElementById('activeUsers').textContent = navigator.onLine ? '1' : '0';
            
            // Save to localStorage
            localStorage.setItem(CONFIG.STORAGE_PREFIX + 'generated', stats.totalGenerated);
            localStorage.setItem(CONFIG.STORAGE_PREFIX + 'revenue', stats.totalRevenue);
            localStorage.setItem(CONFIG.STORAGE_PREFIX + 'pending', stats.pendingPayouts);
        }

        // Select tool
        function selectTool(tool) {
            currentTool = tool;
            document.getElementById('generationArea').style.display = 'block';
            
            // Hide all inputs
            document.querySelectorAll('.tool-inputs').forEach(el => el.style.display = 'none');
            
            // Show selected tool inputs
            const inputsId = tool + 'Inputs';
            if (document.getElementById(inputsId)) {
                document.getElementById(inputsId).style.display = 'block';
            } else {
                // Use image inputs as default
                document.getElementById('imageInputs').style.display = 'block';
            }
            
            // Update header
            const toolInfo = {
                'image': { icon: 'ðŸŽ¨', name: 'AI Image Generator', price: 2.99 },
                'style': { icon: 'ðŸŽ­', name: 'Style Transfer', price: 1.99 },
                'enhance': { icon: 'âœ¨', name: 'Image Enhancer', price: 0.99 },
                'avatar': { icon: 'ðŸ‘¤', name: 'AI Avatar', price: 4.99 },
                'logo': { icon: 'ðŸ’¼', name: 'Logo Creator', price: 9.99 },
                'batch': { icon: 'ðŸ“¦', name: 'Batch Generator', price: 19.99 }
            };
            
            const info = toolInfo[tool];
            document.getElementById('generationIcon').textContent = info.icon;
            document.getElementById('generationName').textContent = info.name;
            currentPrice = info.price;
            
            // Scroll to generation area
            document.getElementById('generationArea').scrollIntoView({ behavior: 'smooth' });
        }

        // Generate Image
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value;
            const style = document.getElementById('imageStyle').value;
            const size = document.getElementById('imageSize').value.split('x');
            
            if (!prompt) {
                alert('Inserisci una descrizione per l\'immagine');
                return;
            }
            
            // Show payment modal
            showPaymentModal(currentPrice);
        }

        // Show payment modal
        function showPaymentModal(amount) {
            document.getElementById('payment-amount').textContent = `â‚¬${amount.toFixed(2)}`;
            document.getElementById('paymentModal').classList.add('active');
            
            // Mount card element if Stripe is initialized
            if (cardElement) {
                cardElement.mount('#card-element');
            }
        }

        // Close payment modal
        function closePayment() {
            document.getElementById('paymentModal').classList.remove('active');
            if (cardElement) {
                cardElement.unmount();
            }
        }

        // Process payment
        async function processPayment() {
            const payBtn = document.getElementById('payBtn');
            payBtn.disabled = true;
            payBtn.textContent = 'Elaborazione...';
            
            if (stripe && cardElement) {
                // Real Stripe payment
                try {
                    const { token, error } = await stripe.createToken(cardElement);
                    
                    if (error) {
                        alert('Errore: ' + error.message);
                        payBtn.disabled = false;
                        payBtn.textContent = 'Conferma Pagamento';
                        return;
                    }
                    
                    // Send token to your server
                    const response = await fetch(CONFIG.PAYMENT_WEBHOOK, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            token: token.id,
                            amount: currentPrice * 100, // Stripe uses cents
                            currency: 'eur',
                            description: 'Viral Machine - ' + currentTool
                        })
                    }).catch(() => null);
                    
                    if (!response || !response.ok) {
                        // Fallback to test mode
                        simulatePayment();
                    } else {
                        // Payment successful
                        paymentSuccess();
                    }
                    
                } catch (error) {
                    console.error('Payment error:', error);
                    simulatePayment();
                }
            } else {
                // Test mode payment
                simulatePayment();
            }
        }

        // Simulate payment for testing
        function simulatePayment() {
            setTimeout(() => {
                paymentSuccess();
            }, 2000);
        }

        // Payment successful
        function paymentSuccess() {
            stats.totalRevenue += currentPrice;
            stats.pendingPayouts += currentPrice * 0.7; // 70% to creator
            updateStats();
            
            closePayment();
            
            // Now generate the content
            actuallyGenerateImage();
        }

        // Actually generate the image
        async function actuallyGenerateImage() {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const outputArea = document.getElementById('outputArea');
            
            progressContainer.classList.add('active');
            outputArea.classList.remove('active');
            progressFill.style.width = '0%';
            
            updateConsole('Generating image...');
            
            try {
                const prompt = document.getElementById('imagePrompt').value;
                const style = document.getElementById('imageStyle').value;
                const size = document.getElementById('imageSize').value.split('x');
                
                progressText.textContent = 'Processando con AI...';
                animateProgress(progressFill, 3000);
                
                // Generate with Python
                const result = await pyodide.runPythonAsync(`
                    generate_procedural_image("${prompt}", "${style}", ${size[0]}, ${size[1]})
                `);
                
                setTimeout(() => {
                    displayImage(result);
                    stats.totalGenerated++;
                    updateStats();
                    
                    // Save to gallery
                    saveToGallery(result, prompt);
                }, 3000);
                
            } catch (error) {
                console.error('Generation error:', error);
                updateConsole('Error: ' + error.message);
            }
        }

        // Display generated image
        function displayImage(imageData) {
            const outputArea = document.getElementById('outputArea');
            const outputContent = document.getElementById('outputContent');
            
            outputArea.classList.add('active');
            document.getElementById('progressContainer').classList.remove('active');
            
            outputContent.innerHTML = `
                <img src="${imageData}" class="output-image" alt="Generated image">
                <div style="margin-top: 1rem;">
                    <button onclick="downloadImage('${imageData}')" style="margin-right: 1rem;" class="generate-btn">
                        ðŸ“¥ Download
                    </button>
                    <button onclick="shareImage('${imageData}')" class="generate-btn">
                        ðŸ“¤ Share
                    </button>
                </div>
            `;
            
            updateConsole('Image generated successfully');
        }

        // Save to gallery
        function saveToGallery(imageData, prompt) {
            const galleryItem = {
                id: Date.now(),
                image: imageData,
                prompt: prompt,
                timestamp: new Date().toISOString()
            };
            
            userImages.unshift(galleryItem);
            
            // Keep only last MAX_IMAGES_PER_USER
            if (userImages.length > CONFIG.MAX_IMAGES_PER_USER) {
                userImages = userImages.slice(0, CONFIG.MAX_IMAGES_PER_USER);
            }
            
            // Save to localStorage
            localStorage.setItem(CONFIG.STORAGE_PREFIX + 'images', JSON.stringify(userImages));
            
            // Update gallery display
            updateGallery();
        }

        // Update gallery display
        function updateGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            
            userImages.forEach(item => {
                const div = document.createElement('div');
                div.className = 'gallery-item';
                div.innerHTML = `<img src="${item.image}" alt="${item.prompt}" title="${item.prompt}">`;
                div.onclick = () => displayImage(item.image);
                gallery.appendChild(div);
            });
        }

        // Load user images
        function loadUserImages() {
            const saved = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'images');
            if (saved) {
                userImages = JSON.parse(saved);
                updateGallery();
            }
        }

        // Download image
        function downloadImage(imageData) {
            const link = document.createElement('a');
            link.href = imageData;
            link.download = 'viral-machine-' + Date.now() + '.png';
            link.click();
        }

        // Share image
        function shareImage(imageData) {
            if (navigator.share) {
                // Convert data URL to blob
                fetch(imageData)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'image.png', { type: 'image/png' });
                        navigator.share({
                            title: 'Check out my AI creation!',
                            text: 'Created with Viral Machine AI',
                            files: [file]
                        });
                    });
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText('Check out my AI creation from Viral Machine!');
                alert('Link copied to clipboard!');
            }
        }

        // Animate progress
        function animateProgress(element, duration) {
            const startTime = Date.now();
            
            function update() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration * 100, 100);
                element.style.width = progress + '%';
                
                if (progress < 100) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // Initialize on load
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
